<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Nod! Debug</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%; height: 100%; overflow: hidden; position: fixed;
        }
        body { 
            font-family: Arial, sans-serif;
            background: #6366f1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: white;
        }
        body.game-mode { justify-content: space-between; }
        #word { 
            font-size: clamp(2.5em, 8vw, 4.5em); 
            font-weight: 900; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px;
        }
        body.game-mode #word { flex: 1; }
        .stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 700px;
            opacity: 0;
        }
        body.game-mode .stats { opacity: 1; }
        #timer, #score { font-size: 2.2em; font-weight: 900; }
        #debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 0.9em;
            border-radius: 5px;
            font-family: monospace;
        }
        .controls {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }
        .controls.hidden { display: none; }
        select { 
            font-size: 1.2em; padding: 12px 20px; 
            border-radius: 12px; border: none; 
            background: white; cursor: pointer;
            font-weight: 700; width: 100%; color: #6366f1;
        }
        .presets { display: flex; gap: 10px; width: 100%; }
        .preset-btn { 
            font-size: 1.1em; padding: 10px 20px; 
            border-radius: 12px; border: 2px solid white; 
            background: transparent; color: white;
            cursor: pointer; font-weight: 800; flex: 1;
        }
        .preset-btn.active { background: white; color: #6366f1; }
        #startBtn {
            font-size: 1.5em; padding: 14px 40px;
            border-radius: 15px; border: none;
            background: white; color: #6366f1;
            font-weight: 900; cursor: pointer;
        }
    </style>
    <script>
        let words = {
            allatok: ['kutya', 'macska', 'oroszlán', 'pingvin', 'kígyó', 'madár', 'hal', 'róka', 'elefánt', 'teknős', 'farkas', 'medve']
        };
        let currentWords = []; 
        let score = 0; 
        let timeLeft = 60; 
        let gameTimer = null; 
        let gameRunning = false; 
        let maxTime = 60;
        let lastTiltTime = 0;
        let initialGamma = null;
        const TILT_THRESHOLD = 30;
        const DEBOUNCE_MS = 850;

        window.onload = () => {
            document.querySelectorAll('.preset-btn').forEach(btn => btn.onclick = selectPreset);
            document.getElementById('startBtn').onclick = startGame;
            selectPreset({target: document.querySelector('.preset-btn[data-time="60"]')});
        };

        function selectPreset(e) {
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            maxTime = parseInt(e.target.dataset.time);
        }

        async function requestOrientationPermission() {
            const permissionGranted = localStorage.getItem('orientationPermission');
            if (permissionGranted === 'granted') return true;
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        localStorage.setItem('orientationPermission', 'granted');
                        return true;
                    }
                    return false;
                } catch(e) {
                    document.getElementById('debug').innerHTML += '<br>Permission error: ' + e;
                    return false;
                }
            } else {
                localStorage.setItem('orientationPermission', 'granted');
                return true;
            }
        }

        async function startGame() {
            if (gameTimer) clearInterval(gameTimer);
            
            const hasPermission = await requestOrientationPermission();
            if (!hasPermission) {
                alert('Tájérzékelő engedély kell!');
                return;
            }
            
            document.body.classList.add('game-mode');
            document.querySelector('.controls').classList.add('hidden');
            
            const cat = document.getElementById('category').value;
            currentWords = [...words[cat]];
            score = 0; 
            timeLeft = maxTime; 
            gameRunning = true;
            lastTiltTime = 0; 
            initialGamma = null;
            updateDisplay();
            newWord();
            
            window.addEventListener('deviceorientation', handleOrientation);
            
            gameTimer = setInterval(() => {
                timeLeft--; 
                updateDisplay();
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function handleOrientation(event) {
            const gamma = event.gamma || 0;
            const beta = event.beta || 0;
            const alpha = event.alpha || 0;
            
            // DEBUG INFO
            document.getElementById('debug').innerHTML = 
                `Gamma: ${gamma.toFixed(1)}°<br>` +
                `Beta: ${beta.toFixed(1)}°<br>` +
                `Alpha: ${alpha.toFixed(1)}°<br>` +
                `Initial: ${initialGamma ? initialGamma.toFixed(1) : 'null'}°<br>` +
                `Diff: ${initialGamma ? (gamma - initialGamma).toFixed(1) : 'N/A'}°`;
            
            if (!gameRunning) return;
            const now = Date.now();
            if (now - lastTiltTime < DEBOUNCE_MS) return;
            
            if (initialGamma === null) {
                initialGamma = gamma;
                return;
            }
            
            const tiltDifference = gamma - initialGamma;
            
            if (tiltDifference > TILT_THRESHOLD) {
                lastTiltTime = now;
                score++;
                document.getElementById('word').textContent = '✓ TALÁLAT!';
                setTimeout(() => {
                    newWord();
                    initialGamma = null;
                }, 600);
            }
            else if (tiltDifference < -TILT_THRESHOLD) {
                lastTiltTime = now;
                document.getElementById('word').textContent = '→ PASSZ';
                setTimeout(() => {
                    newWord();
                    initialGamma = null;
                }, 600);
            }
        }

        function newWord() {
            if (!gameRunning || currentWords.length === 0) return;
            const idx = Math.floor(Math.random() * currentWords.length);
            document.getElementById('word').textContent = currentWords[idx];
        }

        function updateDisplay() {
            document.getElementById('timer').textContent = timeLeft + 's';
            document.getElementById('score').textContent = score;
        }

        function endGame() {
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = null;
            gameRunning = false;
            window.removeEventListener('deviceorientation', handleOrientation);
            document.getElementById('word').textContent = 'Vége! ' + score + ' pont';
            document.body.classList.remove('game-mode');
            document.querySelector('.controls').classList.remove('hidden');
        }
    </script>
</head>
<body>
    <div class="stats">
        <div id="timer">60s</div>
        <div id="score">0</div>
    </div>
    
    <div id="word">Nod!</div>
    <div id="debug">Debug...</div>
    
    <div class="controls">
        <select id="category">
            <option value="allatok">Állatok</option>
        </select>
        
        <div class="presets">
            <button class="preset-btn" data-time="30">30s</button>
            <button class="preset-btn" data-time="45">45s</button>
            <button class="preset-btn active" data-time="60">60s</button>
        </div>
        
        <button id="startBtn">START</button>
    </div>
</body>
</html>
